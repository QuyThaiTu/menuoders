<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Menu ƒë·∫∑t m√≥n</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:20px;
}

.wrapper {
  max-width:900px;
  margin:auto;
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
}

.panel {
  background:#fff;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.menu-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  padding:10px 0;
}

.menu-item:last-child { border-bottom:none; }

.controls button {
  width:28px;
  height:28px;
  margin:0 3px;
}

.cart-line {
  display:flex;
  justify-content:space-between;
  font-size:14px;
}

.total {
  font-weight:bold;
  margin-top:10px;
}

.locked {
  opacity:.6;
  pointer-events:none;
}
</style>
</head>

<body>

<h2>üçΩÔ∏è MENU ƒê·∫∂T M√ìN</h2>

<div class="wrapper" id="app">

  <!-- MENU -->
  <div class="panel">
    <h3>Danh s√°ch m√≥n</h3>
    <div id="menu"></div>
  </div>

  <!-- GI·ªé + QR -->
  <div class="panel">
    <h3>Gi·ªè h√†ng</h3>
    <div id="cart"></div>
    <div class="total">T·ªïng: <span id="total">0</span> ƒë</div>

    <hr>
    <button onclick="generateQR()">T·∫°o QR thanh to√°n</button>
    <div id="qrcode" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabase.createClient(
  'https://xopuxyouxjkiumigcntl.supabase.co',
  'sb_publishable_amT6e0zWSDYtglUIKGZhOw_I7Mqpa4O'
);

/* ================= DATA ================= */
const menuData = [
  { id: 1, name: 'X√¥i g√†', price: 25000 },
  { id: 2, name: 'X√¥i x√° x√≠u', price: 30000 },
  { id: 3, name: 'Tr√† t·∫Øc', price: 15000 }
];

let cart = {};
let billLocked = false;
let billId = null;

/* ================= RENDER MENU ================= */
const menuDiv = document.getElementById('menu');

menuData.forEach(item => {
  const div = document.createElement('div');
  div.className = 'menu-item';
  div.innerHTML = `
    <div>
      <b>${item.name}</b><br>
      <small>${item.price} ƒë</small>
    </div>
    <div class="controls">
      <button onclick="add(${item.id})">+</button>
      <button onclick="remove(${item.id})">-</button>
    </div>
  `;
  menuDiv.appendChild(div);
});

/* ================= CART ================= */
function renderCart() {
  const cartDiv = document.getElementById('cart');
  cartDiv.innerHTML = '';
  let total = 0;

  Object.keys(cart).forEach(id => {
    const m = menuData.find(x => x.id == id);
    const qty = cart[id];
    if (!m || qty <= 0) return;

    const lineTotal = m.price * qty;
    total += lineTotal;

    const line = document.createElement('div');
    line.className = 'cart-line';
    line.innerHTML = `<span>${m.name} x ${qty}</span><span>${lineTotal}</span>`;
    cartDiv.appendChild(line);
  });

  document.getElementById('total').innerText = total;
}

function add(id) {
  if (billLocked) return;
  cart[id] = (cart[id] || 0) + 1;
  renderCart();
}

function remove(id) {
  if (billLocked || !cart[id]) return;
  cart[id]--;
  renderCart();
}

/* ================= SAVE BILL ================= */
async function saveBill() {
  const items = [];
  let total = 0;

  Object.keys(cart).forEach(id => {
    const m = menuData.find(x => x.id == id);
    const qty = cart[id];
    if (!m || qty <= 0) return;

    const price = m.price * qty;
    total += price;
    items.push({ name: m.name, qty, price });
  });

  await supabase.from('bills').insert({
    bill_id: billId,
    items,
    total,
    status: 'UNPAID'
  });
}

/* ================= QR ================= */
async function generateQR() {
  if (billLocked) return;

  billLocked = true;
  document.getElementById('app').classList.add('locked');

  billId = 'BILL-' + Date.now();
  await saveBill();

  const base = location.href.replace(/[^/]*$/, '');
  const url = base + 'bill.html?bill_id=' + billId;

  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 180,
    height: 180
  });
}
</script>

</body>
</html>
