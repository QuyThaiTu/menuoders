<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Menu Ä‘áº·t mÃ³n</title>

<!-- LIB -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:20px;
}

h2 { margin-top:0 }

.wrapper {
  max-width:1000px;
  margin:auto;
  display:grid;
  grid-template-columns: 2fr 1fr;
  gap:20px;
}

.panel {
  background:#fff;
  padding:16px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.menu-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #eee;
  padding:10px 0;
}

.menu-item:last-child { border-bottom:none }

.controls button {
  width:28px;
  height:28px;
  margin:0 2px;
}

.cart-line {
  display:flex;
  justify-content:space-between;
  font-size:14px;
}

.total {
  font-weight:bold;
  margin-top:10px;
}

.locked {
  opacity:.6;
  pointer-events:none;
}

input {
  width:100%;
  padding:6px;
  margin-bottom:6px;
}
</style>
</head>

<body>

<h2>ğŸ½ï¸ Há»† THá»NG Äáº¶T MÃ“N</h2>

<div class="wrapper" id="app">

  <!-- LEFT -->
  <div>
    <div class="panel">
      <h3>â• ThÃªm mÃ³n má»›i</h3>
      <input id="newName" placeholder="TÃªn mÃ³n">
      <input id="newPrice" type="number" placeholder="GiÃ¡ (vd: 25000)">
      <button onclick="addNewItem()">ThÃªm mÃ³n</button>
    </div>

    <div class="panel" style="margin-top:15px">
      <h3>ğŸ“‹ Menu</h3>
      <div id="menu"></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="panel">
    <h3>ğŸ›’ Giá» hÃ ng</h3>
    <div id="cart"></div>
    <div class="total">Tá»•ng tiá»n: <span id="total">0</span> Ä‘</div>

    <hr>
    <button onclick="generateQR()">Táº¡o QR thanh toÃ¡n</button>
    <div id="qrcode" style="margin-top:10px"></div>
  </div>

</div>

<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  'https://xopuxyouxjkiumigcntl.supabase.co',          // <-- THAY
  'sb_publishable_amT6e0zWSDYtglUIKGZhOw_I7Mqpa4O'      // <-- THAY
);

/* ================= DATA ================= */
let menuData = [
  { id: 1, name: 'XÃ´i gÃ ', price: 25000 },
  { id: 2, name: 'XÃ´i xÃ¡ xÃ­u', price: 30000 },
  { id: 3, name: 'TrÃ  táº¯c', price: 15000 }
];

let cart = {};
let billLocked = false;
let billId = null;

/* ================= MENU ================= */
function renderMenu() {
  const menuDiv = document.getElementById('menu');
  menuDiv.innerHTML = '';

  if (menuData.length === 0) {
    menuDiv.innerHTML = '<i>ChÆ°a cÃ³ mÃ³n nÃ o</i>';
    return;
  }

  menuData.forEach(item => {
    const div = document.createElement('div');
    div.className = 'menu-item';
    div.innerHTML = `
      <div>
        <b>${item.name}</b><br>
        <small>${item.price} Ä‘</small>
      </div>
      <div class="controls">
        <button onclick="add(${item.id})">+</button>
        <button onclick="remove(${item.id})">-</button>
      </div>
    `;
    menuDiv.appendChild(div);
  });
}

function addNewItem() {
  if (billLocked) return;

  const name = document.getElementById('newName').value.trim();
  const price = parseInt(document.getElementById('newPrice').value);

  if (!name || !price) {
    alert('Nháº­p tÃªn vÃ  giÃ¡ mÃ³n');
    return;
  }

  menuData.push({
    id: Date.now(),
    name,
    price
  });

  document.getElementById('newName').value = '';
  document.getElementById('newPrice').value = '';

  renderMenu();
}

/* ================= CART ================= */
function renderCart() {
  const cartDiv = document.getElementById('cart');
  cartDiv.innerHTML = '';
  let total = 0;

  Object.keys(cart).forEach(id => {
    const item = menuData.find(m => m.id == id);
    const qty = cart[id];
    if (!item || qty <= 0) return;

    const lineTotal = item.price * qty;
    total += lineTotal;

    const div = document.createElement('div');
    div.className = 'cart-line';
    div.innerHTML = `<span>${item.name} x ${qty}</span><span>${lineTotal}</span>`;
    cartDiv.appendChild(div);
  });

  document.getElementById('total').innerText = total;
}

function add(id) {
  if (billLocked) return;
  cart[id] = (cart[id] || 0) + 1;
  renderCart();
}

function remove(id) {
  if (billLocked || !cart[id]) return;
  cart[id]--;
  renderCart();
}

/* ================= SAVE BILL ================= */
async function saveBill() {
  const items = [];
  let total = 0;

  Object.keys(cart).forEach(id => {
    const item = menuData.find(m => m.id == id);
    const qty = cart[id];
    if (!item || qty <= 0) return;

    const price = item.price * qty;
    total += price;

    items.push({ name: item.name, qty, price });
  });

  await supabaseClient.from('bills').insert({
    bill_id: billId,
    items,
    total,
    status: 'UNPAID'
  });
}

/* ================= QR ================= */
async function generateQR() {
  if (billLocked) return;

  billLocked = true;
  document.getElementById('app').classList.add('locked');

  billId = 'BILL-' + Date.now();
  await saveBill();

  const base = location.href.replace(/[^/]*$/, '');
  const url = base + 'bill.html?bill_id=' + billId;

  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 180,
    height: 180
  });
}

/* ================= INIT ================= */
renderMenu();
renderCart();
</script>

</body>
</html>
