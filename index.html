<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Menu đặt món</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px }
.container { max-width:500px; margin:auto; background:#fff; padding:20px; border-radius:8px }
button { padding:6px 10px; margin:2px }
.lock { opacity:.6; pointer-events:none }
</style>
</head>
<body>

<div class="container">
<h2>MENU</h2>
<div id="menu"></div>

<hr>
<button onclick="generateQR()">TẠO QR THANH TOÁN</button>
<div id="qrcode" style="margin-top:15px"></div>
</div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabase.createClient(
  'SUPABASE_URL',
  'SUPABASE_ANON_KEY'
);

/* ================= DATA ================= */
const menuData = [
  { id: 1, name: 'Xôi gà', price: 25000 },
  { id: 2, name: 'Xôi xá xíu', price: 30000 },
  { id: 3, name: 'Trà tắc', price: 15000 }
];

let cart = {};
let billLocked = false;
let billId = null;

/* ================= RENDER MENU ================= */
const menuDiv = document.getElementById('menu');

menuData.forEach(item => {
  const div = document.createElement('div');
  div.innerHTML = `
    ${item.name} - ${item.price}đ
    <button onclick="add(${item.id})">+</button>
    <button onclick="remove(${item.id})">-</button>
    <span id="qty-${item.id}">0</span>
  `;
  menuDiv.appendChild(div);
});

function add(id) {
  if (billLocked) return;
  cart[id] = (cart[id] || 0) + 1;
  document.getElementById(`qty-${id}`).innerText = cart[id];
}

function remove(id) {
  if (billLocked || !cart[id]) return;
  cart[id]--;
  document.getElementById(`qty-${id}`).innerText = cart[id];
}

/* ================= SAVE BILL ================= */
async function saveBill() {
  const items = [];
  let total = 0;

  Object.keys(cart).forEach(id => {
    const m = menuData.find(x => x.id == id);
    const qty = cart[id];
    if (!m || qty <= 0) return;

    const price = m.price * qty;
    total += price;

    items.push({ name: m.name, qty, price });
  });

  await supabase.from('bills').insert({
    bill_id: billId,
    items: items,
    total: total,
    status: 'UNPAID'
  });
}

/* ================= QR ================= */
async function generateQR() {
  if (billLocked) return;
  billLocked = true;

  billId = 'BILL-' + Date.now();
  await saveBill();

  const base = location.href.replace(/[^/]*$/, '');
  const url = base + 'bill.html?bill_id=' + billId;

  document.getElementById('qrcode').innerHTML = '';
  new QRCode(document.getElementById('qrcode'), {
    text: url,
    width: 180,
    height: 180
  });

  document.querySelector('.container').classList.add('lock');
}
</script>
</body>
</html>
