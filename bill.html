<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bill thanh toán</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px }
.bill { max-width:420px; margin:auto; background:#fff; padding:20px; border-radius:8px }
table { width:100%; border-collapse:collapse; margin-top:10px }
td,th { border-bottom:1px solid #ddd; padding:6px }
.total { font-weight:bold; margin-top:10px }
</style>
</head>
<body>

<div class="bill">
<h2>HÓA ĐƠN</h2>
<div>Mã đơn: <b id="billId"></b></div>
<div>Thời gian: <span id="time"></span></div>

<table>
<thead><tr><th>Món</th><th>SL</th><th>Giá</th></tr></thead>
<tbody id="items"></tbody>
</table>

<div class="total">Tổng tiền: <span id="total"></span> đ</div>

<h3>VietQR</h3>
<img id="vietqr" width="250">
</div>

<script>
/* ================= SUPABASE ================= */
const supabase = supabase.createClient(
  'https://xopuxyouxjkiumigcntl.supabase.co',
  'sb_publishable_amT6e0zWSDYtglUIKGZhOw_I7Mqpa4O'
);

/* ================= PARAM ================= */
const params = new URLSearchParams(location.search);
const billId = params.get('bill_id');

document.getElementById('billId').innerText = billId;
document.getElementById('time').innerText = new Date().toLocaleString();

/* ================= VIETQR ================= */
function generateVietQR(billId, amount) {
  const bank = 'VCB';
  const acc = '0123456789';
  const name = 'NGUYEN VAN A';
  const info = `${billId} ${amount}`;

  return `https://api.vietqr.io/image/${bank}-${acc}-compact.png?amount=${amount}&addInfo=${encodeURIComponent(info)}&accountName=${encodeURIComponent(name)}`;
}

/* ================= LOAD BILL ================= */
(async () => {
  const { data } = await supabase
    .from('bills')
    .select('*')
    .eq('bill_id', billId)
    .single();

  const tbody = document.getElementById('items');
  data.items.forEach(i => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('total').innerText = data.total;
  document.getElementById('vietqr').src =
    generateVietQR(billId, data.total);
})();
</script>

</body>
</html>
